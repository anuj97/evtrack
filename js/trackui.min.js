/*! evtrack -- UI module */
!function(i){var s=i.document,o="mousedown mouseup mousemove mouseover mouseout mousewheel ";o+="touchstart touchend touchmove keydown keyup keypress ";var a="load unload beforeunload blur focus resize error online offline";o=(o+="click dblclick scroll change select submit reset contextmenu cut copy paste").split(" "),a=a.split(" ");var e=o.concat(a),r=0,l=0,c=[],d={settings:{postServer:"//my.server.org/save.script",postInterval:30,regularEvents:"*",pollingEvents:"",pollingMs:150,taskName:"evtrack",callback:null,saveAttributes:!0,debug:!1},record:function(e){for(var n in l=(new Date).getTime(),d.settings)e.hasOwnProperty(n)&&null!==e[n]&&(d.settings[n]=e[n]);d.log("Recording starts...",l,d.settings),d.addEventListeners(),setTimeout(function(){d.initNewData(!0)},1e3*d.settings.postInterval)},addEventListeners:function(){"*"==d.settings.regularEvents?d.addCustomEventListeners(e):(d.log("Settings regular events..."),d.settings.regularEvents=d.settings.regularEvents.split(" "),d.addCustomEventListeners(d.settings.regularEvents)),"*"==d.settings.pollingEvents?d.addCustomEventListeners(e):(d.log("Settings polling events..."),d.settings.pollingEvents=d.settings.pollingEvents.split(" "),d.addCustomEventListeners(d.settings.pollingEvents)),TrackLib.Events.add(i,"beforeunload",d.flush),TrackLib.Events.add(i,"unload",d.flush)},addCustomEventListeners:function(e){d.log("Adding event listeners:",e);for(var n=0;n<e.length;++n){var t=e[n];t&&(-1<o.indexOf(t)?(TrackLib.Events.add(s,t,d.docHandler),d.log("Adding document event:",t),s.attachEvent&&("focus"==t&&TrackLib.Events.add(s.body,"focusin",d.winHandler),"blur"==t&&TrackLib.Events.add(s.body,"focusout",d.winHandler))):-1<a.indexOf(t)&&(TrackLib.Events.add(i,t,d.winHandler),d.log("Adding window event:",t)))}},initNewData:function(e){var n=TrackLib.Dimension.getWindowSize(),t=TrackLib.Dimension.getDocumentSize(),s={url:encodeURIComponent(i.location.href),screenw:screen.width,screenh:screen.height,winw:n.width,winh:n.height,docw:t.width,doch:t.height,info:encodeURIComponent(c.join("|||")),task:encodeURIComponent(d.settings.taskName),action:"init"};if(e||"function"!=typeof navigator.sendBeacon)d.send({async:e,postdata:s,callback:d.setUserId});else{s.beacon=!0;var o=JSON.stringify(s);navigator.sendBeacon(d.settings.postServer,o)}c=[]},setUserId:function(e){r=e.responseText,d.log("setUserId:",r),r&&setInterval(function(){d.appendData(!0)},1e3*d.settings.postInterval)},appendData:function(e){var n={uid:r,info:encodeURIComponent(c.join("|||")),action:"append"};if(e||"function"!=typeof navigator.sendBeacon)0<c.length?d.send({async:e,postdata:n}):d.log("Skipping empty request...");else{n.beacon=!0;var t=JSON.stringify(n);navigator.sendBeacon(d.settings.postServer,t)}c=[]},send:function(e){e.url=d.settings.postServer,TrackLib.XHR.sendAjaxRequest(e)},docHandler:function(e){-1<e.type.indexOf("touch")?d.touchHandler(e):d.eventHandler(e)},winHandler:function(e){d.eventHandler(e)},eventHandler:function(e){e=TrackLib.Events.fix(e);var n=(new Date).getTime(),t=e.type,s=!0;if(0<d.settings.pollingMs&&-1<d.settings.pollingEvents.indexOf(t)&&(s=n-l>=d.settings.pollingMs),s){var o=d.getMousePos(e),i=TrackLib.XPath.getXPath(e.target),a=d.settings.saveAttributes?TrackLib.Util.serializeAttrs(e.target):"{}",r={};"function"==typeof d.settings.callback&&(r=d.settings.callback(e)),d.fillInfo(e.id,n,o.x,o.y,t,i,a,JSON.stringify(r)),l=n}},touchHandler:function(e){var n=(e=TrackLib.Events.fix(e)).changedTouches;if(n)for(var t,s=0;s<n.length;++s)(t=n[s]).type=e.type,d.eventHandler(t)},getMousePos:function(e){var n=0,t=0;return(e=TrackLib.Events.fix(e)).pageX||e.pageY?(n=e.pageX,t=e.pageY):(e.clientX||e.clientY)&&(n=e.clientX+s.body.scrollLeft+s.documentElement.scrollLeft,t=e.clientY+s.body.scrollTop+s.documentElement.scrollTop),(!n||n<0)&&(n=0),(!t||t<0)&&(t=0),{x:n,y:t}},fillInfo:function(){var e=[].slice.apply(arguments);c.push(e.join(" ")),d.log(e)},flush:function(e){var n;for(d.log("Flushing data..."),n=0;n<o.length;++n)TrackLib.Events.remove(s,o[n],d.docHandler);for(n=0;n<a.length;++n)TrackLib.Events.remove(i,a[n],d.winHandler);r?d.appendData(!1):d.initNewData(!1)},log:function(){d.settings.debug&&"function"==typeof console.log&&console.log.apply(console,arguments)}};i.TrackUI=d}(this);
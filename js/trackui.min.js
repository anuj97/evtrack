/*! evtrack -- UI module */
!function(o){var s=o.document,i="mousedown mouseup mousemove mouseover mouseout mousewheel ";i+="touchstart touchend touchmove keydown keyup keypress ";var a="load unload beforeunload blur focus resize error online offline";i=(i+="click dblclick scroll change select submit reset contextmenu cut copy paste").split(" "),a=a.split(" ");var t=i.concat(a),n=0,l=0,r=[],c={settings:{postServer:"//my.server.org/save.script",postInterval:30,regularEvents:"*",pollingEvents:"",pollingMs:150,taskName:"evtrack",callback:null,saveAttributes:!0,layoutType:"liquid",debug:!1},record:function(e){for(var t in l=(new Date).getTime(),c.settings)e.hasOwnProperty(t)&&null!==e[t]&&(c.settings[t]=e[t]);c.log("Recording starts...",l,c.settings),c.addEventListeners(),setTimeout(function(){c.initNewData(!0)},1e3*c.settings.postInterval)},addEventListeners:function(){"*"==c.settings.regularEvents?c.addCustomEventListeners(t):(c.log("Settings regular events..."),c.settings.regularEvents=c.settings.regularEvents.split(" "),c.addCustomEventListeners(c.settings.regularEvents)),"*"==c.settings.pollingEvents?c.addCustomEventListeners(t):(c.log("Settings polling events..."),c.settings.pollingEvents=c.settings.pollingEvents.split(" "),c.addCustomEventListeners(c.settings.pollingEvents));var e="function"==typeof o.onbeforeunload?"beforeunload":"unload";TrackLib.Events.add(o,e,c.flush)},addCustomEventListeners:function(e){c.log("Adding event listeners:",e);for(var t=0;t<e.length;++t){var n=e[t];n&&(-1<i.indexOf(n)?(TrackLib.Events.add(s,n,c.docHandler),c.log("Adding document event:",n),s.attachEvent&&("focus"==n&&TrackLib.Events.add(s.body,"focusin",c.winHandler),"blur"==n&&TrackLib.Events.add(s.body,"focusout",c.winHandler))):-1<a.indexOf(n)&&(TrackLib.Events.add(o,n,c.winHandler),c.log("Adding window event:",n)))}},initNewData:function(e){var t=TrackLib.Dimension.getWindowSize(),n=TrackLib.Dimension.getDocumentSize(),s="url="+encodeURIComponent(o.location.href);s+="&screenw="+screen.width,s+="&screenh="+screen.height,s+="&winw="+t.width,s+="&winh="+t.height,s+="&docw="+n.width,s+="&doch="+n.height,s+="&info="+encodeURIComponent(r.join("|||")),s+="&task="+encodeURIComponent(c.settings.taskName),s+="&action=init",c.send({async:e,postdata:s,callback:c.setUserId}),r=[]},setUserId:function(e){n=e.responseText,c.log("setUserId:",n),n&&setInterval(function(){c.appendData(!0)},1e3*c.settings.postInterval)},appendData:function(e){var t="uid="+n;t+="&info="+encodeURIComponent(r.join("|||")),t+="&action=append",c.send({async:e,postdata:t}),r=[]},send:function(e){e.url=c.settings.postServer,TrackLib.XHR.sendAjaxRequest(e)},docHandler:function(e){-1<e.type.indexOf("touch")?c.touchHandler(e):c.eventHandler(e)},winHandler:function(e){c.eventHandler(e)},eventHandler:function(e){e=TrackLib.Events.fix(e);var t=(new Date).getTime(),n=e.type,s=!0;if(0<c.settings.pollingMs&&-1<c.settings.pollingEvents.indexOf(n)&&(s=t-l>=c.settings.pollingMs),s){var o=c.getMousePos(e),i=TrackLib.XPath.getXPath(e.target),a=c.settings.saveAttributes?TrackLib.Util.serializeAttrs(e.target):"{}",r={};"function"==typeof c.settings.callback&&(r=c.settings.callback(e)),c.fillInfo(e.id,t,o.x,o.y,n,i,a,JSON.stringify(r)),l=t}},touchHandler:function(e){var t=(e=TrackLib.Events.fix(e)).changedTouches;if(t)for(var n,s=0;s<t.length;++s)(n=t[s]).type=e.type,c.eventHandler(n)},getMousePos:function(e){var t=0,n=0;return(e=TrackLib.Events.fix(e)).pageX||e.pageY?(t=e.pageX,n=e.pageY):(e.clientX||e.clientY)&&(t=e.clientX+s.body.scrollLeft+s.documentElement.scrollLeft,n=e.clientY+s.body.scrollTop+s.documentElement.scrollTop),(!t||t<0)&&(t=0),(!n||n<0)&&(n=0),{x:t,y:n}},fillInfo:function(){var e=[].slice.apply(arguments);r.push(e.join(" ")),c.log(e)},flush:function(e){var t;for(c.log("Flushing data...",n),t=0;t<i.length;++t)TrackLib.Events.remove(s,i[t],c.docHandler);for(t=0;t<a.length;++t)TrackLib.Events.remove(o,a[t],c.winHandler);n?c.appendData(!1):c.initNewData(!1)},log:function(){c.settings.debug&&"function"==typeof console.log&&console.log.apply(console,arguments)}};o.TrackUI=c}(this);